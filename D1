#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include "FirebaseESP8266.h"
#include <ESP8266WiFi.h>


#define ECHO D7
#define TRIG D6

LiquidCrystal_I2C lcd(0x27,16,2);    // 주소 0x27, 16x2 디스플레이

#define FIREBASE_HOST "esp8266firebase-c0d21-default-rtdb.firebaseio.com"    //"skku-team5-default-rtdb.firebaseio.com"
#define FIREBASE_AUTH "H1LIBMkrhFGq0gaONtIso13ad7RACrtjdxboJwUN"          // "MMXM31jWhdTJAk1R2VL4rRgKbl6eScjLjpyj0sHM" 
#define WIFI_SSID "qaqa"   // wifi 이름: Galaxy Z Flip 5GF5_42_51
#define WIFI_PASSWORD "01042352423p"  //wifi 비밀번호: 28916195

FirebaseData firebaseData;
FirebaseJson json;
FirebaseConfig config;
FirebaseAuth auth;
void printResult(FirebaseData &data);

void setup(){
  Serial.println("setup start");
  Serial.begin(115200);   // 시리얼 통신, baud rate = 9600 bits / sec
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  
  Serial.println("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println();
  Serial.print("Connected with IP: ");
  Serial.println(WiFi.localIP());
  Serial.println();

  config.database_url = FIREBASE_HOST;
  config.signer.tokens.legacy_token = FIREBASE_AUTH;

  
  Serial.println("Firebase begin");
  Firebase.reconnectWiFi(true);
  Firebase.begin(&config, &auth);
  // firebaseData.setBSSLBufferSize(1024, 1024);
  // firebaseData.setResponseSize(1024);
  // Firebase.setReadTimeout(firebaseData, 1000 * 60);
  // Firebase.setwriteSizeLimit(firebaseData, "tiny");

  // Serial.begin (115200);
  pinMode(TRIG, OUTPUT);
  pinMode(ECHO, INPUT);

  lcd.init();    // lcd 시작
  lcd.backlight();

  
 
  
}

float getVoltage(float inputA0){
  float voltage = 4.2 * inputA0 / (1024);  // analog수치를 디지털 수치로 바꿈.
  return voltage;
}

float getPercent(float voltage){
  float percent = 100 * (voltage-2.4) / (4.2-2.4); // 3.7V 배터리 전압 최고 4.2, 방전시 최소 2.4
  return percent;
}

void callfirebase(float inputA0, float distance){
  float voltage = getVoltage(inputA0);
  float percent = getPercent(voltage);
  Firebase.setFloat(firebaseData, "/esp8266/voltage", voltage);
  Firebase.setFloat(firebaseData, "/esp8266/voltage", percent);
}

void printLcd(float inputA0, float distance){

  lcd.clear();    // 화면을 지운다
  
  float voltage = getVoltage(inputA0);  
  float percent = getPercent(voltage);   
  
  lcd.setCursor(0,0); 
  lcd.print(inputA0);
  lcd.print(" ");
 
  lcd.print(percent);
  lcd.print("%");

  lcd.setCursor(0,1); 
  lcd.print(voltage);
  lcd.print("V ");
 
  lcd.print(distance);
  lcd.print("cm");

}



float getDistance(){
  float duration;
  float distance;
  digitalWrite(TRIG, HIGH);
  delay(10);
  digitalWrite(TRIG, LOW);
  duration = pulseIn(ECHO, HIGH);
  distance = ((float) (340 * duration) / 10000) / 2;
  Serial.print("Duration: ");
  Serial.print(duration);
  Serial.print(" Distance: ");
  Serial.print(distance);
  Serial.println("cm\n");

  return distance;

}

void loop(){
  float inputA0 = analogRead(0);  //0-1024 사이의 수치가 A0으로 들어옴.
  float distance = getDistance();
  
  printLcd(inputA0, distance);
  Serial.println("A");
  callfirebase(inputA0, distance);

  delay(2900);       // ( ) msec 동안 표시
  
  lcd.clear();
  delay(100);     // ( ) msec 동안 clear
 

      
}
